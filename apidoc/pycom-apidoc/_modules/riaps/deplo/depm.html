

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>riaps.deplo.depm &mdash; RIAPS  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> RIAPS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">riaps</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">RIAPS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>riaps.deplo.depm</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for riaps.deplo.depm</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Deployment manager service main class</span>
<span class="sd">Created on Oct 19, 2016</span>

<span class="sd">@author: riaps</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">pwd</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">import</span> <span class="nn">capnp</span>
<span class="kn">from</span> <span class="nn">concurrent.futures.thread</span> <span class="k">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span> <span class="nn">_thread</span> <span class="k">import</span> <span class="n">RLock</span>

<span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">from</span> <span class="nn">zmq</span> <span class="k">import</span> <span class="n">devices</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span>
    <span class="n">pickle</span> <span class="o">=</span> <span class="n">cPickle</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">cPickle</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">Cryptodome.PublicKey</span> <span class="k">import</span> <span class="n">RSA</span>
<span class="kn">from</span> <span class="nn">Cryptodome.Signature</span> <span class="k">import</span> <span class="n">PKCS1_v1_5</span>
<span class="kn">from</span> <span class="nn">Cryptodome.Hash</span> <span class="k">import</span> <span class="n">SHA256</span>

<span class="kn">from</span> <span class="nn">riaps.consts.defs</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">riaps.utils.sudo</span> <span class="k">import</span> <span class="n">riaps_sudo</span><span class="p">,</span><span class="n">is_su</span>
<span class="kn">from</span> <span class="nn">riaps.utils.config</span> <span class="k">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">riaps.proto</span> <span class="k">import</span> <span class="n">deplo_capnp</span>
<span class="kn">from</span> <span class="nn">riaps.proto</span> <span class="k">import</span> <span class="n">disco_capnp</span>
<span class="kn">from</span> <span class="nn">riaps.run.exc</span> <span class="k">import</span> <span class="n">BuildError</span>
<span class="kn">from</span> <span class="nn">riaps.deplo.resm</span> <span class="k">import</span> <span class="n">ResourceManager</span>
<span class="kn">from</span> <span class="nn">riaps.deplo.procm</span> <span class="k">import</span> <span class="n">ProcessManager</span>
<span class="kn">from</span> <span class="nn">riaps.deplo.appdb</span> <span class="k">import</span> <span class="n">AppDbase</span>
<span class="kn">from</span> <span class="nn">riaps.utils.ifaces</span> <span class="k">import</span> <span class="n">get_unix_dns_ips</span>
<span class="kn">from</span> <span class="nn">riaps.utils.names</span> <span class="k">import</span> <span class="n">actorIdentity</span>

<span class="c1"># Record of the app</span>
<span class="n">DeploAppRecord</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;DeploAppRecord&#39;</span><span class="p">,</span> <span class="s1">&#39;model hash file home hosts network&#39;</span><span class="p">)</span>
<span class="c1"># Record of a user</span>
<span class="n">DeploUserRecord</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;DeploUserRecord&#39;</span><span class="p">,</span> <span class="s1">&#39;name home uid gid&#39;</span><span class="p">)</span>
<span class="c1"># Record of an actor</span>
<span class="n">DeploActorRecord</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;DeploActorRecord&#39;</span><span class="p">,</span> <span class="s1">&#39;app model actor args device control monitor&#39;</span><span class="p">)</span>
<span class="c1"># Record of an device actor</span>
<span class="n">DeviceActorRecord</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;DeviceActorRecord&#39;</span><span class="p">,</span> <span class="s1">&#39;app model actor args device control monitor&#39;</span><span class="p">)</span>
<span class="c1"># Record of an app actor command </span>
<span class="n">DeploActorCommand</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;DeploActorCommand&#39;</span><span class="p">,</span> <span class="s1">&#39;app model actor args cmd pid&#39;</span><span class="p">)</span>
<span class="c1"># Record of the disco command</span>
<span class="n">DeploDiscoCommand</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;DeploDiscoCommand&#39;</span><span class="p">,</span> <span class="s1">&#39;cmd pid&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="DeploymentManager"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager">[docs]</a><span class="k">class</span> <span class="nc">DeploymentManager</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Deployment manager service main class, implemented as a thread </span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="n">DISCONAME</span> <span class="o">=</span> <span class="s1">&#39;riaps.disco&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">resm</span><span class="p">,</span><span class="n">fm</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostAddress</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">hostAddress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macAddress</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">macAddress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macAddress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">riapsApps</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">riapsApps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">riapsHome</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">riapsHome</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>            <span class="c1"># Map of launched actors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launchRefs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>           <span class="c1"># Reference count for device actors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapLock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>          <span class="c1"># Lock to protect launchMap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discoLock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>        <span class="c1"># Lock to protect disco </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disco</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbaseHost</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasePort</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="n">fm</span>                    <span class="c1"># Fault manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span> <span class="o">=</span> <span class="n">resm</span>                <span class="c1"># Resource manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">procm</span> <span class="o">=</span> <span class="n">ProcessManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># self.devm.setProcessManager(self.procm)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>            <span class="c1"># App models loaded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">setupUser</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">TARGET_USER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appUser</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actors</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>       <span class="c1"># Actors started</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peerQueue</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>    <span class="c1"># Peer messages for actors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>      <span class="c1"># Device actors started</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>     <span class="c1"># Monitors of actor messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poller</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">riaps_actor_file</span> <span class="o">=</span> <span class="s1">&#39;riaps_actor&#39;</span>   <span class="c1"># Default name for the executable riaps actor shell</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">riaps.riaps_actor</span>            <span class="c1"># Try to import the python riaps_actor first so that we know is correct file name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">riaps_actor_file</span> <span class="o">=</span> <span class="n">riaps</span><span class="o">.</span><span class="n">riaps_actor</span><span class="o">.</span><span class="vm">__file__</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">riaps_device_file</span> <span class="o">=</span> <span class="s1">&#39;riaps_device&#39;</span>       <span class="c1"># Default name for the executable riaps device shell</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">riaps.riaps_device</span>          <span class="c1"># We try to import the python riaps_device first so that we know is correct file name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">riaps_device_file</span> <span class="o">=</span> <span class="n">riaps</span><span class="o">.</span><span class="n">riaps_device</span><span class="o">.</span><span class="vm">__file__</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>       
        
        <span class="bp">self</span><span class="o">.</span><span class="n">riaps_disco_file</span> <span class="o">=</span> <span class="s1">&#39;riaps_disco&#39;</span>   <span class="c1"># Default name for the executable riaps disco </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">riaps.riaps_disco</span>            <span class="c1"># Try to import the python riaps_disco first so that we know is correct file name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">riaps_disco_file</span> <span class="o">=</span> <span class="n">riaps</span><span class="o">.</span><span class="n">riaps_disco</span><span class="o">.</span><span class="vm">__file__</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">depmCommandEndpoint</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">depmCommandEndpoint</span>
        <span class="c1"># self.devmCommandEndpoint = parent.devmCommandEndpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">procMonEndpoint</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">procMonEndpoint</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PAIR</span><span class="p">)</span>        <span class="c1"># Socket to recv commands from main</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">RCVTIMEO</span><span class="p">,</span><span class="n">const</span><span class="o">.</span><span class="n">depmRecvTimeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depmCommandEndpoint</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">discoCommand</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span> <span class="o">=</span> <span class="n">AppDbase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_su</span> <span class="o">=</span> <span class="n">is_su</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pendingCall</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">SECURITY</span><span class="p">:</span>
            <span class="n">riaps_sudo</span><span class="p">(</span><span class="s1">&#39;iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT&#39;</span><span class="p">)</span>  <span class="c1"># track conn&#39;s</span>
            <span class="n">riaps_sudo</span><span class="p">(</span><span class="s1">&#39;iptables -A INPUT -m conntrack --ctstate INVALID -j DROP&#39;</span><span class="p">)</span>                <span class="c1"># drop invalid state packets</span>
            <span class="n">riaps_sudo</span><span class="p">(</span><span class="s1">&#39;iptables -A INPUT -i lo -j ACCEPT&#39;</span><span class="p">)</span>                                       <span class="c1"># accept lo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dns_ips</span> <span class="o">=</span> <span class="n">get_unix_dns_ips</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dns_ips</span> <span class="o">=</span> <span class="p">[]</span>


<div class="viewcode-block" id="DeploymentManager.doCommand"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.doCommand">[docs]</a>    <span class="k">def</span> <span class="nf">doCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cmd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;doCommand: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">send_pyobj</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeploymentManager.callCommand"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.callCommand">[docs]</a>    <span class="k">def</span> <span class="nf">callCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cmd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;callCommand: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pendingCall</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">send_pyobj</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pendingCall</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">recv_pyobj</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pendingCall</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">zmq</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ZMQError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">return</span> <span class="n">reply</span></div>
        
<div class="viewcode-block" id="DeploymentManager.setupUser"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.setupUser">[docs]</a>    <span class="k">def</span> <span class="nf">setupUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">user_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">pw_record</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span>
        <span class="n">user_record</span> <span class="o">=</span> <span class="n">DeploUserRecord</span><span class="p">(</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">pw_record</span><span class="o">.</span><span class="n">pw_name</span><span class="p">,</span> 
                    <span class="n">home</span> <span class="o">=</span> <span class="n">pw_record</span><span class="o">.</span><span class="n">pw_dir</span><span class="p">,</span> 
                    <span class="n">uid</span> <span class="o">=</span> <span class="n">pw_record</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> 
                    <span class="n">gid</span> <span class="o">=</span> <span class="n">pw_record</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_record</span></div>
        
<div class="viewcode-block" id="DeploymentManager.delUser"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.delUser">[docs]</a>    <span class="k">def</span> <span class="nf">delUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">user_name</span> <span class="o">==</span> <span class="n">Config</span><span class="o">.</span><span class="n">TARGET_USER</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="n">user_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_name</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="DeploymentManager.makeLdLibEnv"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.makeLdLibEnv">[docs]</a>    <span class="k">def</span> <span class="nf">makeLdLibEnv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">os_env</span><span class="p">,</span><span class="n">libs</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">if</span> <span class="n">libs</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ld_libs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;LD_LIBRARY_PATH&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ld_libs</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ld_libs</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">libs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ld_libs</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">libs</span><span class="p">)</span>
            <span class="n">os_env</span><span class="p">[</span><span class="s1">&#39;LD_LIBRARY_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ld_libs</span></div>
        
<div class="viewcode-block" id="DeploymentManager.makeUserEnv"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.makeUserEnv">[docs]</a>    <span class="k">def</span> <span class="nf">makeUserEnv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_name</span><span class="p">,</span><span class="n">ld_libs</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">user_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">user_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_name</span><span class="p">]</span>
        <span class="n">user_env</span><span class="p">[</span> <span class="s1">&#39;HOME&#39;</span>     <span class="p">]</span>  <span class="o">=</span> <span class="n">user_record</span><span class="o">.</span><span class="n">home</span>
        <span class="n">user_env</span><span class="p">[</span> <span class="s1">&#39;LOGNAME&#39;</span>  <span class="p">]</span>  <span class="o">=</span> <span class="n">user_record</span><span class="o">.</span><span class="n">name</span>
        <span class="n">user_env</span><span class="p">[</span> <span class="s1">&#39;PWD&#39;</span>      <span class="p">]</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">user_env</span><span class="p">[</span> <span class="s1">&#39;USER&#39;</span>     <span class="p">]</span>  <span class="o">=</span> <span class="n">user_record</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">ld_libs</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeLdLibEnv</span><span class="p">(</span><span class="n">user_env</span><span class="p">,</span><span class="n">ld_libs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user_env</span></div>

<div class="viewcode-block" id="DeploymentManager.demote"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.demote">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">demote</span><span class="p">(</span><span class="n">user_uid</span><span class="p">,</span><span class="n">user_gid</span><span class="p">,</span><span class="n">is_su</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">result</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">is_su</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">user_gid</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">user_uid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>
    

<div class="viewcode-block" id="DeploymentManager.connectDisco"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.connectDisco">[docs]</a>    <span class="k">def</span> <span class="nf">connectDisco</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">discoCommand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>           <span class="c1"># Socket to command disco</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discoCommand</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">RCVTIMEO</span><span class="p">,</span><span class="n">const</span><span class="o">.</span><span class="n">discoEndpointRecvTimeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discoCommand</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SNDTIMEO</span><span class="p">,</span><span class="n">const</span><span class="o">.</span><span class="n">discoEndpointSendTimeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discoCommand</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">discoEndpoint</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DeploymentManager.startDisco"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.startDisco">[docs]</a>    <span class="k">def</span> <span class="nf">startDisco</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Start the Discovery Service process </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting disco&quot;</span><span class="p">)</span>
        <span class="n">disco_prog</span> <span class="o">=</span> <span class="s1">&#39;riaps_disco&#39;</span>
        <span class="n">disco_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">riaps_disco_file</span>   <span class="c1"># File name for python script riaps_disco.py</span>

        <span class="n">disco_arg1</span> <span class="o">=</span> <span class="s1">&#39;--database&#39;</span>
        <span class="n">disco_arg2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbaseHost</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasePort</span><span class="p">)</span>
        <span class="n">user_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">Config</span><span class="o">.</span><span class="n">TARGET_USER</span><span class="p">]</span>
        <span class="n">user_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeUserEnv</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">TARGET_USER</span><span class="p">)</span>
        <span class="n">user_uid</span> <span class="o">=</span> <span class="n">user_record</span><span class="o">.</span><span class="n">uid</span>
        <span class="n">user_gid</span> <span class="o">=</span> <span class="n">user_record</span><span class="o">.</span><span class="n">gid</span>
        <span class="n">user_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">disco_prog</span><span class="p">,</span><span class="n">disco_arg1</span><span class="p">,</span><span class="n">disco_arg2</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disco</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span>
                                      <span class="n">preexec_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demote</span><span class="p">(</span><span class="n">user_uid</span><span class="p">,</span> <span class="n">user_gid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">is_su</span><span class="p">),</span> 
                                      <span class="n">cwd</span><span class="o">=</span><span class="n">user_cwd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">user_env</span><span class="p">)</span>
    
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span><span class="n">disco_mod</span><span class="p">]</span> <span class="o">+</span> <span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disco</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span>
                                          <span class="n">preexec_fn</span><span class="o">=</span><span class="n">DeploymentManager</span><span class="o">.</span><span class="n">demote</span><span class="p">(</span><span class="n">user_uid</span><span class="p">,</span> <span class="n">user_gid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">is_su</span><span class="p">),</span> 
                                          <span class="n">cwd</span><span class="o">=</span><span class="n">user_cwd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">user_env</span><span class="p">)</span>    
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error while starting disco: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">procm</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DISCONAME</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">disco</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectDisco</span><span class="p">()</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disco</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span>
        <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">info</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span><span class="s1">&#39;cmdline&#39;</span><span class="p">])</span>
                   <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cmdline&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">setDiscoCommand</span><span class="p">(</span><span class="n">DeploDiscoCommand</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">cmdline</span><span class="p">,</span><span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;disco started&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DeploymentManager.setupDisco"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.setupDisco">[docs]</a>    <span class="k">def</span> <span class="nf">setupDisco</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbaseHost</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasePort</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disco</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">setDisco</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startDisco</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;disco already started&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectDisco</span><span class="p">()</span>
            <span class="k">pass</span></div>
    
    
<div class="viewcode-block" id="DeploymentManager.setupApp"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.setupApp">[docs]</a>    <span class="k">def</span> <span class="nf">setupApp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Set up model and unique user name for app&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        
        <span class="n">appName</span><span class="p">,</span><span class="n">appModelName</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="n">appFolder</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riapsApps</span><span class="p">,</span> <span class="n">appName</span><span class="p">)</span>
        <span class="n">appModelPath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">appFolder</span><span class="p">,</span> <span class="n">appModelName</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">appFolder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s1">&#39;app folder is missing: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">appFolder</span><span class="p">)</span>
        
        <span class="c1"># Load the app model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadModel</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">appModelPath</span><span class="p">)</span>
        <span class="c1"># Make it unique (to last 4 digits of suffix)</span>
        <span class="n">userName</span> <span class="o">=</span> <span class="n">appName</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>  
        <span class="c1"># self.appUser[appName] = userName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">setupApp</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">appFolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">setupApp</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">appFolder</span><span class="p">,</span><span class="n">userName</span><span class="p">)</span>  <span class="c1"># Adds user </span>
        <span class="n">userName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">getUserName</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>       <span class="c1"># resm may revert to default user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appUser</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span> <span class="o">=</span> <span class="n">userName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupUser</span><span class="p">(</span><span class="n">userName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">addApp</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DeploymentManager.verifyPackage"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.verifyPackage">[docs]</a>    <span class="k">def</span> <span class="nf">verifyPackage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyName</span><span class="p">,</span><span class="n">sigName</span><span class="p">,</span><span class="n">dataName</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">keyName</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">key</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sigName</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataName</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">rsakey</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">signer</span> <span class="o">=</span> <span class="n">PKCS1_v1_5</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rsakey</span><span class="p">)</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">SHA256</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="n">digest</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">signer</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeploymentManager.installPackage"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.installPackage">[docs]</a>    <span class="k">def</span> <span class="nf">installPackage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Install a downloaded app package</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">(</span><span class="n">appName</span><span class="p">,)</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tgz_file</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riapsApps</span><span class="p">,</span><span class="n">appName</span> <span class="o">+</span> <span class="s1">&#39;.tgz&#39;</span><span class="p">)</span>
            <span class="n">sha_file</span> <span class="o">=</span> <span class="n">tgz_file</span> <span class="o">+</span> <span class="s1">&#39;.sha256&#39;</span>
            <span class="n">rsa_public_key</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riapsHome</span><span class="p">,</span><span class="s2">&quot;keys/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ctrlPublicKey</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifyPackage</span><span class="p">(</span><span class="n">rsa_public_key</span><span class="p">,</span><span class="n">sha_file</span><span class="p">,</span><span class="n">tgz_file</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Error while verifying app &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">appName</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:Signature verification failed&#39;</span> <span class="o">%</span> <span class="n">appName</span>
    
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tgz_file</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
                <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riapsApps</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Content extraction failed&#39;</span> 

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tgz_file</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sha_file</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;App package removal failed&#39;</span>
        
        <span class="k">return</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="DeploymentManager.installApp"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.installApp">[docs]</a>    <span class="k">def</span> <span class="nf">installApp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">installPackage</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">send_pyobj</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DeploymentManager.cleanupApp"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.cleanupApp">[docs]</a>    <span class="k">def</span> <span class="nf">cleanupApp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Clean up everything related to an app&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">(</span><span class="n">appName</span><span class="p">,)</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="n">appName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">cleanupApp</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">cleanupApp</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">delApp</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">appName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">appUser</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">userName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appUser</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">appUser</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delUser</span><span class="p">(</span><span class="n">userName</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeploymentManager.cleanupApps"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.cleanupApps">[docs]</a>    <span class="k">def</span> <span class="nf">cleanupApps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Clean up all known apps &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">delApp</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">cleanupApps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">cleanupApps</span><span class="p">()</span></div>
                
<div class="viewcode-block" id="DeploymentManager.loadModel"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.loadModel">[docs]</a>    <span class="k">def</span> <span class="nf">loadModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">modelFileName</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">modelFileName</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>  
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;I/O error(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected error:&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="c1"># Check if the app model is already loaded</span>
        <span class="n">_fileHash</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fileData</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fileHash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">fileData</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">appName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span><span class="p">:</span>   <span class="c1"># There is an app with this name</span>
            <span class="n">appRecord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span>
            <span class="n">appHash</span> <span class="o">=</span> <span class="n">appRecord</span><span class="o">.</span><span class="n">hash</span>
            <span class="k">if</span> <span class="n">fileHash</span> <span class="o">==</span> <span class="n">appHash</span><span class="p">:</span>     <span class="c1"># Hash is the same, we have the model loaded</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span> 
        <span class="c1"># Not loaded yet (or new)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">modelFileName</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>  
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;I/O error(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected error:&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="n">home</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">network</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">modelFileName</span><span class="p">),</span><span class="n">const</span><span class="o">.</span><span class="n">appDescFile</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">org</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">home</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">home</span>
                <span class="n">network</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">network</span>
                <span class="n">hosts</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">hosts</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeploAppRecord</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="n">fileHash</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> 
                                                 <span class="n">file</span><span class="o">=</span><span class="n">modelFileName</span><span class="p">,</span> <span class="n">home</span><span class="o">=</span><span class="n">home</span><span class="p">,</span>
                                                 <span class="n">hosts</span><span class="o">=</span><span class="n">hosts</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="DeploymentManager.getAppRecord"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.getAppRecord">[docs]</a>    <span class="k">def</span> <span class="nf">getAppRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">appName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s1">&#39;App &quot;</span><span class="si">%s</span><span class="s1">&quot; unknown&#39;</span> <span class="o">%</span> <span class="n">appName</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">appModels</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="DeploymentManager.getAppModel"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.getAppModel">[docs]</a>    <span class="k">def</span> <span class="nf">getAppModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppRecord</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span><span class="o">.</span><span class="n">model</span></div>
    
<div class="viewcode-block" id="DeploymentManager.getAppHome"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.getAppHome">[docs]</a>    <span class="k">def</span> <span class="nf">getAppHome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppRecord</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span><span class="o">.</span><span class="n">home</span></div>
    
<div class="viewcode-block" id="DeploymentManager.getAppHosts"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.getAppHosts">[docs]</a>    <span class="k">def</span> <span class="nf">getAppHosts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppRecord</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span><span class="o">.</span><span class="n">hosts</span></div>
    
<div class="viewcode-block" id="DeploymentManager.getAppNetwork"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.getAppNetwork">[docs]</a>    <span class="k">def</span> <span class="nf">getAppNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppRecord</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span><span class="o">.</span><span class="n">network</span></div>
    
<div class="viewcode-block" id="DeploymentManager.setupAppSite"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.setupAppSite">[docs]</a>    <span class="k">def</span> <span class="nf">setupAppSite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">site</span><span class="p">,</span><span class="n">user_name</span><span class="p">,</span><span class="n">done</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span> <span class="k">return</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">site</span><span class="p">)</span> 
            <span class="n">riaps_sudo</span><span class="p">(</span><span class="s2">&quot;iptables -A OUTPUT -d </span><span class="si">%s</span><span class="s2"> -m owner --uid-owner </span><span class="si">%s</span><span class="s2"> -j ACCEPT&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">user_name</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s1">&#39;Error in setting up access to </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">site</span><span class="p">,</span><span class="n">user_name</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="DeploymentManager.setupAppDNS"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.setupAppDNS">[docs]</a>    <span class="k">def</span> <span class="nf">setupAppDNS</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_name</span><span class="p">,</span><span class="n">done</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dns_ip</span> <span class="ow">in</span> <span class="n">get_unix_dns_ips</span><span class="p">():</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">setupAppSite</span><span class="p">(</span><span class="n">dns_ip</span><span class="p">,</span><span class="n">user_name</span><span class="p">,</span><span class="n">done</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeploymentManager.setupAppNetworkSites"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.setupAppNetworkSites">[docs]</a>    <span class="k">def</span> <span class="nf">setupAppNetworkSites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sites</span><span class="p">,</span><span class="n">user_name</span><span class="p">,</span><span class="n">done</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Node can access any network</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="s1">&#39;dns&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setupAppDNS</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setupAppSite</span><span class="p">(</span><span class="n">site</span><span class="p">,</span><span class="n">user_name</span><span class="p">,</span><span class="n">done</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>     </div>
                    
<div class="viewcode-block" id="DeploymentManager.setupAppNetwork"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.setupAppNetwork">[docs]</a>    <span class="k">def</span> <span class="nf">setupAppNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">user_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="o">.</span><span class="n">SECURITY</span><span class="p">:</span> <span class="k">return</span>              <span class="c1"># No security</span>
        <span class="k">if</span> <span class="n">user_name</span> <span class="o">==</span> <span class="n">Config</span><span class="o">.</span><span class="n">TARGET_USER</span><span class="p">:</span> <span class="k">return</span>  <span class="c1"># Don&#39;t restrict default target user </span>
        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupAppSite</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span><span class="n">user_name</span><span class="p">,</span><span class="n">done</span><span class="p">)</span>   <span class="c1"># ACCEPT localhost</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppHosts</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>               <span class="c1"># ACCEPT riaps peers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupAppNetworkSites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
        <span class="n">network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppNetwork</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="n">network</span><span class="p">[</span><span class="s1">&#39;[]&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;[]&#39;</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>   <span class="c1"># Sites from global list</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupAppNetworkSites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span> <span class="k">return</span>   <span class="c1"># Access to any network</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="n">network</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hostAddress</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostAddress</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupAppNetworkSites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span> <span class="k">return</span>   <span class="c1"># Access to any network</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0/0&#39;</span>                                 <span class="c1"># deny access to all others</span>
        <span class="n">riaps_sudo</span><span class="p">(</span><span class="s2">&quot;iptables -A OUTPUT -d </span><span class="si">%s</span><span class="s2"> -m owner --uid-owner </span><span class="si">%s</span><span class="s2"> -j DROP&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">user_name</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="DeploymentManager.startActor"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.startActor">[docs]</a>    <span class="k">def</span> <span class="nf">startActor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Start an actor of an application </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="n">appName</span><span class="p">,</span><span class="n">appModel</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">actorArgs</span> <span class="o">=</span> <span class="n">msg</span>
        
        <span class="n">appHome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppHome</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        
        <span class="c1"># Starter</span>
        <span class="n">riaps_prog</span> <span class="o">=</span> <span class="s1">&#39;riaps_actor&#39;</span>

        <span class="n">appFolder</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riapsApps</span><span class="p">,</span> <span class="n">appName</span><span class="p">)</span>
        <span class="n">appModelPath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">appFolder</span><span class="p">,</span> <span class="n">appModel</span><span class="p">)</span>
         
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">appFolder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s1">&#39;App folder is missing: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">appFolder</span><span class="p">)</span>
    
        <span class="n">componentTypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getComponentTypes</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">componentTypes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Actor has no components: </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">))</span>
            <span class="c1"># raise BuildError(&#39;Actor has no components: %s.%s.&#39; % (appName,actorName))</span>
        <span class="k">for</span> <span class="n">componentType</span> <span class="ow">in</span> <span class="n">componentTypes</span><span class="p">:</span>
            <span class="c1"># Look up the Python version first</span>
            <span class="n">pyFilePath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">appFolder</span><span class="p">,</span> <span class="n">componentType</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pyFilePath</span><span class="p">):</span> <span class="k">continue</span>
            <span class="c1"># Look up the C++version </span>
            <span class="n">ccFilePath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">appFolder</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span> <span class="o">+</span> <span class="n">componentType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.so&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ccFilePath</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s1">&#39;Implementation of component </span><span class="si">%s</span><span class="s1"> is missing&#39;</span> <span class="o">%</span> <span class="n">componentType</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">addActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getActorModel</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">addActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getActorModel</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">))</span>
        <span class="n">riaps_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">riaps_actor_file</span>   <span class="c1">#  File name for python script &#39;riaps_actor.py&#39;</span>
    
        <span class="n">userName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appUser</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span>
        <span class="n">user_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">userName</span><span class="p">]</span>
        <span class="n">user_ld_libs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppLibs</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        <span class="n">user_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeUserEnv</span><span class="p">(</span><span class="n">userName</span><span class="p">,</span><span class="n">user_ld_libs</span><span class="p">)</span>
        
        <span class="n">user_env</span><span class="p">[</span><span class="s1">&#39;PATHS_FROM_ECLIPSE_TO_PYTHON&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[[</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1">,</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1">]]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">appHome</span><span class="p">,</span><span class="n">appFolder</span><span class="p">)</span>
        
        <span class="n">user_uid</span> <span class="o">=</span> <span class="n">user_record</span><span class="o">.</span><span class="n">uid</span>
        <span class="n">user_gid</span> <span class="o">=</span> <span class="n">user_record</span><span class="o">.</span><span class="n">gid</span>
        <span class="n">user_cwd</span> <span class="o">=</span> <span class="n">appFolder</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setupAppNetwork</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">userName</span><span class="p">)</span>
        
        <span class="n">riaps_arg1</span> <span class="o">=</span> <span class="n">appName</span>
        <span class="n">riaps_arg2</span> <span class="o">=</span> <span class="n">appModelPath</span>
        <span class="n">riaps_arg3</span> <span class="o">=</span> <span class="n">actorName</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">riaps_prog</span><span class="p">,</span><span class="n">riaps_arg1</span><span class="p">,</span><span class="n">riaps_arg2</span><span class="p">,</span><span class="n">riaps_arg3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">actorArgs</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">APP_LOGS</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">logFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riapsApps</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span>
            <span class="n">logFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logFileName</span> <span class="p">,</span><span class="s2">&quot;ab&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logFile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Launching </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span>
                                <span class="n">preexec_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demote</span><span class="p">(</span><span class="n">user_uid</span><span class="p">,</span> <span class="n">user_gid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">is_su</span><span class="p">),</span> 
                                <span class="n">cwd</span><span class="o">=</span><span class="n">user_cwd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">user_env</span><span class="p">,</span> 
                                <span class="n">stdout</span><span class="o">=</span><span class="n">logFile</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span><span class="ne">PermissionError</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># if isPython:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span><span class="n">riaps_mod</span><span class="p">]</span> <span class="o">+</span> <span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="c1"># else:</span>
                <span class="c1">#    command = [riaps_prog] + command[1:]</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span>
                                    <span class="n">preexec_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demote</span><span class="p">(</span><span class="n">user_uid</span><span class="p">,</span> <span class="n">user_gid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">is_su</span><span class="p">),</span> 
                                    <span class="n">cwd</span><span class="o">=</span><span class="n">user_cwd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">user_env</span><span class="p">,</span>
                                    <span class="n">stdout</span><span class="o">=</span><span class="n">logFile</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error while starting actor: </span><span class="si">%s</span><span class="s2"> -- </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">raise</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">depmStartTimeout</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s2">&quot;Actor failed to start: </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">))</span>
        
        <span class="n">pid</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span>
        <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">info</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span><span class="s1">&#39;cmdline&#39;</span><span class="p">])</span> 
                   <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cmdline&#39;</span><span class="p">]</span>
                   
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">startActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">startActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actorName</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapLock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeploActorRecord</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">appName</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">appModel</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="n">actorName</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">actorArgs</span><span class="p">,</span> 
                                                <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">control</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">monitor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peerQueue</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">addAppActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">DeploActorCommand</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">appName</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">appModel</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="n">actorName</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="n">actorArgs</span><span class="p">,</span>
                                                             <span class="n">cmd</span><span class="o">=</span><span class="n">cmdline</span><span class="p">,</span><span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">procm</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">proc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeploymentManager.getActorModel"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.getActorModel">[docs]</a>    <span class="k">def</span> <span class="nf">getActorModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppModel</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">actorName</span> <span class="ow">in</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;actors&quot;</span><span class="p">]:</span>
            <span class="n">actorModel</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;actors&quot;</span><span class="p">][</span><span class="n">actorName</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">actorName</span> <span class="ow">in</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;devices&quot;</span><span class="p">]:</span>
            <span class="n">actorModel</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;devices&quot;</span><span class="p">][</span><span class="n">actorName</span><span class="p">]</span>    <span class="c1"># TODO:needs a proper actor model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s1">&#39;Actor &quot;</span><span class="si">%s</span><span class="s1">&quot; unknown&#39;</span> <span class="o">%</span> <span class="n">actorName</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">actorModel</span></div>

<div class="viewcode-block" id="DeploymentManager.getAppLibs"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.getAppLibs">[docs]</a>    <span class="k">def</span> <span class="nf">getAppLibs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppModel</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        <span class="n">app_libs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">libraries</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;libraries&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
            <span class="n">app_libs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">app_libs</span></div>
        
<div class="viewcode-block" id="DeploymentManager.getComponentTypes"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.getComponentTypes">[docs]</a>    <span class="k">def</span> <span class="nf">getComponentTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Collects all the component types of an actor.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">componentTypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">appModel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppModel</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        <span class="n">componentDefs</span> <span class="o">=</span> <span class="n">appModel</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">]</span>
        <span class="n">actorModel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getActorModel</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">actorModel</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]:</span>
            <span class="n">compType</span> <span class="o">=</span> <span class="n">actorModel</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">compType</span> <span class="ow">in</span> <span class="n">componentDefs</span><span class="p">:</span>           <span class="c1"># Component</span>
                <span class="n">componentTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compType</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>                                <span class="c1"># Device component</span>
            
        <span class="k">return</span> <span class="n">componentTypes</span></div>
    
<div class="viewcode-block" id="DeploymentManager.terminateActor"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.terminateActor">[docs]</a>    <span class="k">def</span> <span class="nf">terminateActor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">proc</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Terminate actor (runs in a background thread)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">qualName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actorName</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Terminating </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>          
                <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>                    <span class="c1"># Should check for errors</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">depmTermTimeout</span><span class="p">)</span>    <span class="c1"># Wait here</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actor </span><span class="si">%s</span><span class="s2"> terminated&quot;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actor </span><span class="si">%s</span><span class="s2"> did not terminate - killing it&quot;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unRegisterActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="DeploymentManager.stopActor"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.stopActor">[docs]</a>    <span class="k">def</span> <span class="nf">stopActor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Stop the actor of an application.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">qualName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actorName</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapLock</span><span class="p">:</span>
            <span class="c1"># assert qualName in self.launchMap</span>
            <span class="k">if</span> <span class="n">qualName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Actor </span><span class="si">%s</span><span class="s1"> has not been started&#39;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">proc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping actor </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">stopActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">stopActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">device</span>
            <span class="n">_control</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">control</span>
            <span class="n">_monitor</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">monitor</span>
            <span class="c1"># TODO: Stop the zmqdevice, disconnect/destroy sockets</span>
            <span class="n">device</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>          <span class="c1"># Terminate context for zmqDevice</span>
            <span class="n">device</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="c1"># control.close()                # TODO remove sockets from poller</span>
            <span class="c1"># monitor.close()                </span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">procm</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">qualName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">delAppActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminateActor</span><span class="p">,</span><span class="n">proc</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeploymentManager.haltActor"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.haltActor">[docs]</a>    <span class="k">def</span> <span class="nf">haltActor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Ask the background thread to stop the actor of an application  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">appName</span><span class="p">,</span><span class="n">actorName</span> <span class="o">=</span> <span class="n">msg</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BuildError</span> <span class="k">as</span> <span class="n">buildError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">buildError</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>
    
<div class="viewcode-block" id="DeploymentManager.unRegisterActor"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.unRegisterActor">[docs]</a>    <span class="k">def</span> <span class="nf">unRegisterActor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">actorPid</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Unregister a dead actor from the disco service</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">discoLock</span><span class="p">:</span>
            <span class="n">reqt</span> <span class="o">=</span> <span class="n">disco_capnp</span><span class="o">.</span><span class="n">DiscoReq</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
            <span class="n">appMessage</span> <span class="o">=</span> <span class="n">reqt</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;actorUnreg&#39;</span><span class="p">)</span>
            <span class="n">appMessage</span><span class="o">.</span><span class="n">appName</span> <span class="o">=</span> <span class="n">appName</span>
            <span class="n">appMessage</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;0.0.0&#39;</span>
            <span class="n">appMessage</span><span class="o">.</span><span class="n">actorName</span> <span class="o">=</span> <span class="n">actorName</span>
            <span class="n">appMessage</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">actorPid</span>
                      
            <span class="n">msgBytes</span> <span class="o">=</span> <span class="n">reqt</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discoCommand</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msgBytes</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to unregister app with discovery: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">respBytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discoCommand</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No response from discovery service: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="n">resp</span> <span class="o">=</span> <span class="n">disco_capnp</span><span class="o">.</span><span class="n">DiscoRep</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">respBytes</span><span class="p">)</span>
            
            <span class="n">which</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">which</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;actorUnreg&#39;</span><span class="p">:</span>
                <span class="n">respMessage</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">actorUnreg</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">respMessage</span><span class="o">.</span><span class="n">status</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;ok&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;unregistered &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Bad response from disco service at app unregistration&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected response from disco service at app unregistration&quot;</span><span class="p">)</span></div>
                
                
<div class="viewcode-block" id="DeploymentManager.queryApps"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.queryApps">[docs]</a>    <span class="k">def</span> <span class="nf">queryApps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># This should be self.actors </span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">appName</span><span class="p">,</span><span class="n">actorName</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">appName</span> <span class="ow">in</span> <span class="n">reply</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">actors</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span>
                <span class="n">actors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">actorName</span><span class="p">]</span>
                <span class="n">reply</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span> <span class="o">=</span> <span class="n">actors</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reply</span><span class="p">[</span><span class="n">appName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">actorName</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">send_pyobj</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeploymentManager.reclaimApp"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.reclaimApp">[docs]</a>    <span class="k">def</span> <span class="nf">reclaimApp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">appName</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">reclaimApp</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">send_pyobj</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="DeploymentManager.handleCommand"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleCommand">[docs]</a>    <span class="k">def</span> <span class="nf">handleCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleCommand: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;launch&#39;</span><span class="p">:</span>             <span class="c1"># Launch an actor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startActor</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;halt&quot;</span><span class="p">:</span>             <span class="c1"># Halt an actor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">haltActor</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;setupApp&quot;</span><span class="p">:</span>         <span class="c1"># Setup an app</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setupApp</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;cleanupApp&quot;</span><span class="p">:</span>       <span class="c1"># Cleanup an app</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanupApp</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;cleanupApps&quot;</span><span class="p">:</span>      <span class="c1"># Cleanup all apps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanupApps</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;setDisco&quot;</span><span class="p">:</span>         <span class="c1"># Set up disco </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setupDisco</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;query&quot;</span><span class="p">:</span>            <span class="c1"># Query running apps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queryApps</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;reclaim&quot;</span><span class="p">:</span>          <span class="c1"># Reclaim app files (for riaps)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reclaimApp</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;install&quot;</span><span class="p">:</span>          <span class="c1"># Install downloaded package</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">installApp</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span><span class="p">:</span> 
            <span class="n">info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in handleCommand &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="DeploymentManager.kill"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">what</span><span class="p">,</span><span class="n">pid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;killing </span><span class="si">%s</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">what</span><span class="p">,</span><span class="n">pid</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ESRCH</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ESRCH</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;terminated [</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;killing [</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ESRCH</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;killed [</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>
                <span class="k">return</span></div>
        
<div class="viewcode-block" id="DeploymentManager.stopOrphanDisco"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.stopOrphanDisco">[docs]</a>    <span class="k">def</span> <span class="nf">stopOrphanDisco</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">getDiscoCommand</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">record</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmdline</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">cmd</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">pid</span> 
            <span class="n">infoList</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">info</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span><span class="s1">&#39;cmdline&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infoList</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cmdline</span> <span class="o">==</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;cmdline&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stopping orphan disco [</span><span class="si">%d</span><span class="s2">] &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="s1">&#39;orphan disco&#39;</span><span class="p">,</span><span class="n">pid</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">delDiscoCommand</span><span class="p">()</span></div>
                    
        
<div class="viewcode-block" id="DeploymentManager.stopOrphanActor"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.stopOrphanActor">[docs]</a>    <span class="k">def</span> <span class="nf">stopOrphanActor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">record</span><span class="p">):</span>
        <span class="n">cmdline</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">cmd</span>
        <span class="n">pid</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">actor</span>
        <span class="n">infoList</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">info</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span><span class="s1">&#39;cmdline&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infoList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmdline</span> <span class="o">==</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;cmdline&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stopping orphan actor [</span><span class="si">%d</span><span class="s2">] &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="s1">&#39;orphan actor&#39;</span><span class="p">,</span><span class="n">pid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">delAppActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">)</span></div>
                
<div class="viewcode-block" id="DeploymentManager.unregisterOrphanActor"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.unregisterOrphanActor">[docs]</a>    <span class="k">def</span> <span class="nf">unregisterOrphanActor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">record</span><span class="p">):</span>
        <span class="n">pid</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">actor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unRegisterActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">pid</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DeploymentManager.recover"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.recover">[docs]</a>    <span class="k">def</span> <span class="nf">recover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">disco</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">getDisco</span><span class="p">()</span>
        <span class="n">apps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">getApps</span><span class="p">()</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span> 
        <span class="n">recs</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">:</span>                            <span class="c1"># Stop orphan actors </span>
            <span class="n">acts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">getAppActors</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
            <span class="n">cmds</span><span class="p">[</span><span class="n">app</span><span class="p">]</span> <span class="o">=</span> <span class="n">acts</span>
            <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">acts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stopOrphanActor</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
                <span class="n">recs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">act</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">disco</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>                           <span class="c1"># Recover discovery</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopOrphanDisco</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;recover: disco = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">disco</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setupDisco</span><span class="p">(</span><span class="n">disco</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">:</span>                            <span class="c1"># Unregister orphan actors from disco</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unregisterOrphanActor</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">:</span>
            <span class="n">appSet</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;recover: app = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="p">))</span>
            <span class="n">acts</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">app</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">acts</span><span class="p">:</span>
                <span class="n">appName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">act</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
                <span class="n">actName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">act</span><span class="o">.</span><span class="n">actor</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">appSet</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">setupApp</span><span class="p">((</span><span class="n">act</span><span class="o">.</span><span class="n">app</span><span class="p">,</span><span class="n">act</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
                        <span class="n">appSet</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;recover: actor = </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actName</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">startActor</span><span class="p">((</span><span class="n">act</span><span class="o">.</span><span class="n">app</span><span class="p">,</span><span class="n">act</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">act</span><span class="o">.</span><span class="n">actor</span><span class="p">,</span><span class="n">act</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;recovery failed: actor = </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actName</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">delAppActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actName</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeploymentManager.pollMonitor"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.pollMonitor">[docs]</a>    <span class="k">def</span> <span class="nf">pollMonitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poller</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">[(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">[</span><span class="n">sock</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeploymentManager.run"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Main loop of the depl service</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting&quot;</span><span class="p">)</span>
        <span class="c1"># self.printApps()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Server socket for client requests</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>  
            <span class="n">endpoint</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">deplEndpoint</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
            <span class="c1"># Control socket to receive commands from main thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PAIR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depmCommandEndpoint</span><span class="p">)</span>
            <span class="c1"># Socket to communicate with procmon threads</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">procmon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">procmon</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">procMonEndpoint</span><span class="p">)</span>
            <span class="c1"># Socket for communication with fault monitor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fmmon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">setupFMMon</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">getUUID</span><span class="p">()</span>
            <span class="c1"># Socket for communication with NIC manager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nicmon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">setupNICMon</span><span class="p">()</span>
            <span class="c1"># Poller for commands, requests, and procmon messages             </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">()</span>                   
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span><span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctrl</span><span class="p">,</span><span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">procmon</span><span class="p">,</span><span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmmon</span><span class="p">,</span><span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nicmon</span><span class="p">,</span><span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
            <span class="c1"># Map of clients</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clients</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>  
            <span class="c1"># Event for termination</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>     <span class="c1"># Event flag to signal termination</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;running&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># </span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;start failed&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recover</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="k">break</span>
            <span class="n">sockets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">))</span> <span class="c1"># Poll client messages, with timeout 1 sec</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sockets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                    <span class="c1"># If no message but timeout expired, </span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> 
                    <span class="k">break</span>                           <span class="c1"># break out if terminated</span>
            <span class="n">toDelete</span> <span class="o">=</span> <span class="p">[]</span>           
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sockets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl</span><span class="p">:</span>                  <span class="c1"># Handle commands from main</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">recv_pyobj</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handleCommand</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">:</span>              <span class="c1"># Handle client requests</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handleClient</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">procmon</span><span class="p">:</span>             <span class="c1"># Handle procmon messages</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handleProcmon</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmmon</span><span class="p">:</span>               <span class="c1"># Handle fault monitor messages</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handleFMMon</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nicmon</span><span class="p">:</span>              <span class="c1"># Handle NIC monitor messages</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handleNICMon</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                        <span class="n">msgBytes</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">handleActorMessage</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">msgBytes</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown socket&quot;</span><span class="p">)</span>
                <span class="n">toDelete</span> <span class="o">+=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">toDelete</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">sockets</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>                
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>
    
            
<div class="viewcode-block" id="DeploymentManager.handleClient"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleClient">[docs]</a>    <span class="k">def</span> <span class="nf">handleClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msgBytes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle a message from a client (i.e. an actor) </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleClient&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplReq</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">msgBytes</span><span class="p">)</span>
            <span class="n">which</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">which</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;actorReg&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handleActorReg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;deviceGet&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handleDeviceReq</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;deviceRel&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handleDeviceRel</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;reportEvent&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handleReportEvent</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span><span class="p">:</span> 
            <span class="n">info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in handleClient &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>


<div class="viewcode-block" id="DeploymentManager.setupClient"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.setupClient">[docs]</a>    <span class="k">def</span> <span class="nf">setupClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">_appVersion</span><span class="p">,</span><span class="n">appActorName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set up a new client of the deplo manager. The client actors are to register with</span>
<span class="sd">        the manager using the &#39;server&#39; (REQ/REP) socket. The manager will then create a dedicated</span>
<span class="sd">        (PAIR) socket for the client to connect to. This socket is used as a private communication</span>
<span class="sd">        channel between a specific client actor and the service.   </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PAIR</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">bind_to_random_port</span><span class="p">(</span><span class="s1">&#39;tcp://127.0.0.1&#39;</span><span class="p">)</span>
        <span class="n">clientKeyBase</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">appName</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">appActorName</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="n">clientKeyBase</span><span class="p">]</span> <span class="o">=</span> <span class="n">sock</span>
        <span class="n">clientKeyLocal</span> <span class="o">=</span> <span class="n">clientKeyBase</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">macAddress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="n">clientKeyLocal</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span>
        <span class="n">clientKeyGlobal</span> <span class="o">=</span> <span class="n">clientKeyBase</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostAddress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="n">clientKeyGlobal</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">port</span></div>
    
<div class="viewcode-block" id="DeploymentManager.binder"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.binder">[docs]</a>    <span class="k">def</span> <span class="nf">binder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">binder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
        <span class="n">iface</span> <span class="o">=</span> <span class="s1">&#39;tcp://127.0.0.1&#39;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">binder</span><span class="o">.</span><span class="n">bind_to_random_port</span><span class="p">(</span><span class="n">iface</span><span class="p">)</span>
        <span class="n">binder</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">port</span></div>
    
<div class="viewcode-block" id="DeploymentManager.handleActorReg"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleActorReg">[docs]</a>    <span class="k">def</span> <span class="nf">handleActorReg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle the registration of an application actor with the service. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">actReg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">actorReg</span>
        <span class="n">appName</span> <span class="o">=</span> <span class="n">actReg</span><span class="o">.</span><span class="n">appName</span>
        <span class="n">appVersion</span> <span class="o">=</span> <span class="n">actReg</span><span class="o">.</span><span class="n">version</span>   
        <span class="n">appActorName</span> <span class="o">=</span> <span class="n">actReg</span><span class="o">.</span><span class="n">actorName</span>
        <span class="n">isDevice</span> <span class="o">=</span> <span class="n">actReg</span><span class="o">.</span><span class="n">isDevice</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleActorReg: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> 
                         <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">appActorName</span><span class="p">,</span> <span class="s1">&#39;[device]&#39;</span> <span class="k">if</span> <span class="n">isDevice</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        
        <span class="n">qualName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">appActorName</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>        
        <span class="k">if</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isDevice</span> <span class="ow">and</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
                <span class="n">_actorRecord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="n">err</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">isDevice</span> <span class="ow">and</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
                <span class="n">_actorRecord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="n">err</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;unknown actor: </span><span class="si">%s</span><span class="s1"> - rejected&#39;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span>
            <span class="n">rsp</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplRep</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
            <span class="n">rspMessage</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;actorReg&#39;</span><span class="p">)</span>
            <span class="n">rspMessage</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;err&#39;</span>
            <span class="n">rspBytes</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">rspBytes</span><span class="p">)</span>   
            <span class="k">return</span>
        
        <span class="n">clientPort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupClient</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">appVersion</span><span class="p">,</span><span class="n">appActorName</span><span class="p">)</span>
        <span class="n">clientPID</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span><span class="o">.</span><span class="n">pid</span>
        
        <span class="n">zmqDevice</span> <span class="o">=</span> <span class="n">devices</span><span class="o">.</span><span class="n">ThreadProxy</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">,</span><span class="n">zmq</span><span class="o">.</span><span class="n">PAIR</span><span class="p">,</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">actorIdentity</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">appActorName</span><span class="p">,</span> <span class="n">clientPID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;zmqDevice ID = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identity</span><span class="p">)</span>
        <span class="n">zmqDevice</span><span class="o">.</span><span class="n">setsockopt_in</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="n">identity</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf_8&#39;</span><span class="p">))</span>
        <span class="c1"># device.setsockopt_in(zmq.RCVTIMEO,const.deplEndpointRecvTimeout)</span>
        <span class="c1"># device.setsockopt_out(zmq.SNDTIMEO,const.deplEndpointSendTimeout)</span>
        <span class="n">zmqDevice</span><span class="o">.</span><span class="n">bind_out</span><span class="p">(</span><span class="s1">&#39;tcp://127.0.0.1:</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">clientPort</span><span class="p">)</span>      <span class="c1"># </span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">addClientDevice</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">appActorName</span><span class="p">,</span><span class="n">zmqDevice</span><span class="p">)</span>
        
        <span class="c1"># Socket for sending control messages to the actor</span>
        <span class="n">actorControl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>
        <span class="n">actorPort</span> <span class="o">=</span> <span class="n">actorControl</span><span class="o">.</span><span class="n">bind_to_random_port</span><span class="p">(</span><span class="s1">&#39;tcp://127.0.0.1&#39;</span><span class="p">)</span>
        <span class="n">zmqDevice</span><span class="o">.</span><span class="n">connect_in</span><span class="p">(</span><span class="s1">&#39;tcp://127.0.0.1:</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">actorPort</span><span class="p">)</span>
        
        <span class="c1"># Monitoring socket to intercept messages going to the actor</span>
        <span class="n">monPort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binder</span><span class="p">()</span>
        <span class="n">monAddr</span> <span class="o">=</span> <span class="s1">&#39;tcp://127.0.0.1:</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">monPort</span>
        <span class="n">zmqDevice</span><span class="o">.</span><span class="n">bind_mon</span><span class="p">(</span><span class="n">monAddr</span><span class="p">)</span>

        <span class="n">actorMonitor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
        <span class="n">actorMonitor</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">actorMonitor</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">monAddr</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pollMonitor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">appActorName</span><span class="p">,</span><span class="n">actorMonitor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">addClientDevice</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">appActorName</span><span class="p">,</span><span class="n">zmqDevice</span><span class="p">)</span>
        
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">zmqDevice</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">actorArgs</span> <span class="o">=</span> <span class="n">_actorRecord</span><span class="o">.</span><span class="n">args</span>
        <span class="n">appModel</span> <span class="o">=</span> <span class="n">_actorRecord</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="n">isDevice</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeviceActorRecord</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">appName</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">appModel</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="n">appActorName</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">actorArgs</span><span class="p">,</span>
                                                       <span class="n">device</span><span class="o">=</span><span class="n">zmqDevice</span><span class="p">,</span> 
                                                       <span class="n">control</span> <span class="o">=</span> <span class="n">actorControl</span><span class="p">,</span> <span class="n">monitor</span> <span class="o">=</span> <span class="n">actorMonitor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeploActorRecord</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">appName</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">appModel</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="n">appActorName</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">actorArgs</span><span class="p">,</span>
                                                     <span class="n">device</span><span class="o">=</span><span class="n">zmqDevice</span><span class="p">,</span> 
                                                     <span class="n">control</span> <span class="o">=</span> <span class="n">actorControl</span><span class="p">,</span> <span class="n">monitor</span> <span class="o">=</span> <span class="n">actorMonitor</span><span class="p">)</span>
                
        <span class="n">rsp</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplRep</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
        <span class="n">rspMessage</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;actorReg&#39;</span><span class="p">)</span>
        <span class="n">rspMessage</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span>
        <span class="n">rspMessage</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">clientPort</span>
        <span class="n">rspMessage</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">rspBytes</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">rspBytes</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isDevice</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handlePeerQueue</span><span class="p">(</span><span class="n">qualName</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeploymentManager.handlePeerQueue"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handlePeerQueue">[docs]</a>    <span class="k">def</span> <span class="nf">handlePeerQueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">qualName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Process delayed messages from peer message queue</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapLock</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
            <span class="n">control</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">control</span>
            <span class="k">assert</span> <span class="n">control</span> <span class="o">!=</span> <span class="kc">None</span>
            <span class="n">msgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peerQueue</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
                <span class="n">cmd</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">peer</span> <span class="o">=</span> <span class="n">msg</span>
                <span class="k">assert</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;peer+&#39;</span><span class="p">,</span><span class="s1">&#39;peer-&#39;</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actorName</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">key</span> <span class="o">==</span> <span class="n">qualName</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplCmd</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
                <span class="n">msgMessage</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;peerInfoMsg&#39;</span><span class="p">)</span>
                <span class="n">msgMessage</span><span class="o">.</span><span class="n">peerState</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span> <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;peer+&#39;</span> <span class="k">else</span> <span class="s1">&#39;off&#39;</span>
                <span class="n">msgMessage</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">peer</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">msgBytes</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">msgBytes</span><span class="p">)</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span><span class="o">.</span><span class="n">pid</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="n">actorIdentity</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">control</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">header</span><span class="p">,</span><span class="n">payload</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peerQueue</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>
        
<div class="viewcode-block" id="DeploymentManager.startDevice"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.startDevice">[docs]</a>    <span class="k">def</span> <span class="nf">startDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">appModel</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">actorArgs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Start a device actor for an application </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actorName</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapLock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">launchRefs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> 
                <span class="k">return</span>
        
        <span class="n">appHome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppHome</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        
        <span class="c1"># Starter </span>
        <span class="n">riaps_prog</span> <span class="o">=</span> <span class="s1">&#39;riaps_device&#39;</span>      <span class="c1">#</span>
        
        <span class="n">riaps_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">riaps_device_file</span>  <span class="c1"># Module file name for script </span>
        
        <span class="n">appFolder</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riapsApps</span><span class="p">,</span><span class="n">appName</span><span class="p">)</span>
        <span class="n">appModelPath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">appFolder</span><span class="p">,</span><span class="n">appModel</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">appFolder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s1">&#39;App folder is missing: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">appFolder</span><span class="p">)</span>
        
        <span class="n">componentType</span> <span class="o">=</span> <span class="n">actorName</span> 
        <span class="c1"># Look up the Python version first</span>
        <span class="n">pyFilePath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">appFolder</span><span class="p">,</span> <span class="n">componentType</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pyFilePath</span><span class="p">):</span>
            <span class="k">pass</span>                <span class="c1"># Use the Python implementation</span>
        <span class="k">else</span><span class="p">:</span>                   <span class="c1"># Find C++ implementation</span>
            <span class="n">ccFilePath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">appFolder</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span> <span class="o">+</span> <span class="n">componentType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.so&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ccFilePath</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s1">&#39;Implementation of component </span><span class="si">%s</span><span class="s1"> is missing&#39;</span> <span class="o">%</span> <span class="n">componentType</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">addActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getActorModel</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">addActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getActorModel</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">))</span>
        
        <span class="n">dev_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>          
        
        <span class="n">dev_env</span><span class="p">[</span><span class="s1">&#39;PATHS_FROM_ECLIPSE_TO_PYTHON&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[[</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1">,</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1">]]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">appHome</span><span class="p">,</span><span class="n">appFolder</span><span class="p">)</span>
           
        <span class="n">app_libs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAppLibs</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makeLdLibEnv</span><span class="p">(</span><span class="n">dev_env</span><span class="p">,</span><span class="n">app_libs</span><span class="p">)</span>
        
        <span class="n">riaps_arg1</span> <span class="o">=</span> <span class="n">appName</span> 
        <span class="n">riaps_arg2</span> <span class="o">=</span> <span class="n">appModelPath</span>
        <span class="n">riaps_arg3</span> <span class="o">=</span> <span class="n">actorName</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">riaps_prog</span><span class="p">,</span><span class="n">riaps_arg1</span><span class="p">,</span><span class="n">riaps_arg2</span><span class="p">,</span><span class="n">riaps_arg3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">actorArgs</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">APP_LOGS</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">logFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riapsApps</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span>
            <span class="n">logFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logFileName</span> <span class="p">,</span><span class="s2">&quot;ab&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logFile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Launching </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">cwd</span><span class="o">=</span><span class="n">appFolder</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="n">dev_env</span><span class="p">,</span> 
                                <span class="n">stdout</span><span class="o">=</span><span class="n">logFile</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span><span class="n">riaps_mod</span><span class="p">]</span> <span class="o">+</span> <span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span>
                                        <span class="n">cwd</span><span class="o">=</span><span class="n">appFolder</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="n">dev_env</span><span class="p">,</span>
                                        <span class="n">stdout</span><span class="o">=</span><span class="n">logFile</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s2">&quot;Error while starting device: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">depmStartTimeout</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="s2">&quot;Device failed to start: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">startActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">startActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actorName</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapLock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">launchRefs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeviceActorRecord</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">appName</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">appModel</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="n">actorName</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">actorArgs</span><span class="p">,</span> 
                                                  <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">control</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">monitor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">procm</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">proc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeploymentManager.terminateDevice"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.terminateDevice">[docs]</a>    <span class="k">def</span> <span class="nf">terminateDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">proc</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Ultimate operation to terminate a device</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">qualName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actorName</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>            <span class="c1"># Should check for errors</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">depmTermTimeout</span><span class="p">)</span>   
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Device </span><span class="si">%s</span><span class="s2"> terminated&quot;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span> <span class="c1"># </span>
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Device </span><span class="si">%s</span><span class="s2"> did not stop - killing it&quot;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unRegisterActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>    <span class="c1"># Clean discovery service</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="DeploymentManager.stopDevice"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.stopDevice">[docs]</a>    <span class="k">def</span> <span class="nf">stopDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Stop a device actor of an application </span>
<span class="sd">        &#39;&#39;&#39;</span>        
        <span class="n">qualName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actorName</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapLock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qualName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchRefs</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchRefs</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">launchRefs</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchRefs</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">proc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping device </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">procm</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">qualName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">running</span><span class="p">:</span>       
                <span class="bp">self</span><span class="o">.</span><span class="n">terminateDevice</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DeploymentManager.handleDeviceReq"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleDeviceReq">[docs]</a>    <span class="k">def</span> <span class="nf">handleDeviceReq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle the request for a device </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">devGet</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">deviceGet</span>
        <span class="n">appName</span> <span class="o">=</span> <span class="n">devGet</span><span class="o">.</span><span class="n">appName</span> 
        <span class="n">modelName</span> <span class="o">=</span> <span class="n">devGet</span><span class="o">.</span><span class="n">modelName</span>
        <span class="n">typeName</span> <span class="o">=</span> <span class="n">devGet</span><span class="o">.</span><span class="n">typeName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleDeviceReq: </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">typeName</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">devGet</span><span class="o">.</span><span class="n">deviceArgs</span><span class="p">)))</span>
        
        <span class="n">cmdArgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">deviceArg</span> <span class="ow">in</span> <span class="n">devGet</span><span class="o">.</span><span class="n">deviceArgs</span><span class="p">:</span>
            <span class="n">argName</span> <span class="o">=</span> <span class="n">deviceArg</span><span class="o">.</span><span class="n">name</span>
            <span class="n">argValue</span> <span class="o">=</span> <span class="n">deviceArg</span><span class="o">.</span><span class="n">value</span>
            <span class="n">cmdArgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="n">argName</span><span class="p">)</span>
            <span class="n">cmdArgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">argValue</span><span class="p">)</span>
        
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startDevice</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">modelName</span><span class="p">,</span> <span class="n">typeName</span><span class="p">,</span> <span class="n">cmdArgs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BuildError</span> <span class="k">as</span> <span class="n">buildError</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">buildError</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1">#      </span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplRep</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
        <span class="n">rspMessage</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;deviceGet&#39;</span><span class="p">)</span>
        <span class="n">rspMessage</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="s2">&quot;err&quot;</span>
        <span class="n">rspBytes</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">rspBytes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleDeviceReq: done&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeploymentManager.handleDeviceRel"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleDeviceRel">[docs]</a>    <span class="k">def</span> <span class="nf">handleDeviceRel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle the release of a device </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">devRel</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">deviceRel</span>
        <span class="n">appName</span> <span class="o">=</span> <span class="n">devRel</span><span class="o">.</span><span class="n">appName</span> 
        <span class="n">_modelName</span> <span class="o">=</span> <span class="n">devRel</span><span class="o">.</span><span class="n">modelName</span>
        <span class="n">typeName</span> <span class="o">=</span> <span class="n">devRel</span><span class="o">.</span><span class="n">typeName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleDeviceRel: </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">typeName</span><span class="p">))</span>
        
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># self.stopDevice(appName, typeName)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stopDevice</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">typeName</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BuildError</span> <span class="k">as</span> <span class="n">buildError</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">buildError</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1">#      </span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplRep</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
        <span class="n">rspMessage</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;deviceRel&#39;</span><span class="p">)</span>
        <span class="n">rspMessage</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="s2">&quot;err&quot;</span>
        <span class="n">rspBytes</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">rspBytes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleDeviceRel: done&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeploymentManager.handleReportEvent"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleReportEvent">[docs]</a>    <span class="k">def</span> <span class="nf">handleReportEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle the event report from actor </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">repEvt</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">reportEvent</span>
        <span class="n">appName</span> <span class="o">=</span> <span class="n">repEvt</span><span class="o">.</span><span class="n">appName</span>
        <span class="n">_appVersion</span> <span class="o">=</span> <span class="n">repEvt</span><span class="o">.</span><span class="n">version</span>   
        <span class="n">actorName</span> <span class="o">=</span> <span class="n">repEvt</span><span class="o">.</span><span class="n">actorName</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">repEvt</span><span class="o">.</span><span class="n">msg</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleReportEvent: </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">))</span>
        
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># self.stopDevice(appName, typeName)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Event from </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">BuildError</span> <span class="k">as</span> <span class="n">buildError</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">buildError</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1">#      </span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplRep</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
        <span class="n">rspMessage</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;reportEvent&#39;</span><span class="p">)</span>
        <span class="n">rspMessage</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="s2">&quot;err&quot;</span>
        <span class="n">rspBytes</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">rspBytes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleReportEvent: done&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeploymentManager.stop"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stopping&quot;</span><span class="p">)</span>
        <span class="c1"># Clean up everything</span>
        <span class="c1"># Logout from service</span>
        <span class="c1"># Kill actors</span>
        <span class="n">toHalt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">appName</span><span class="p">,</span><span class="n">actorName</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">toHalt</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">toHalt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">haltActor</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="c1"># time.sleep(3.0) # Allow actors terminate cleanly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>    <span class="c1"># Ensure all actors have terminated </span>
        <span class="c1"># Cleanup resm </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resm</span><span class="o">.</span><span class="n">cleanupApps</span><span class="p">()</span>
        <span class="c1"># Cleanup fm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">cleanupApps</span><span class="p">()</span>
        <span class="c1"># Terminate disco</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disco</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">procm</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DISCONAME</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disco</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disco</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">closeDbase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stopped&quot;</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="DeploymentManager.reinstate"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.reinstate">[docs]</a>    <span class="k">def</span> <span class="nf">reinstate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Ask actors to reinstate their connections to deplo</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">qualName</span><span class="p">,</span><span class="n">proc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="n">control</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">control</span>
                <span class="n">appName</span><span class="p">,</span> <span class="n">actName</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">actor</span>
                <span class="k">if</span> <span class="n">control</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> 
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplCmd</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
                    <span class="n">msgMessage</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;reinstateCmd&#39;</span><span class="p">)</span>
                    <span class="n">msgMessage</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;doit&#39;</span>
                    <span class="n">msgBytes</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">msgBytes</span><span class="p">)</span>
                    <span class="n">identity</span> <span class="o">=</span> <span class="n">actorIdentity</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actName</span><span class="p">,</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">control</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">header</span><span class="p">,</span><span class="n">payload</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;reinstate req to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">qualName</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># TODO queue up reinstate command for later send</span>
                    <span class="k">pass</span></div>
        
<div class="viewcode-block" id="DeploymentManager.handleProcmon"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleProcmon">[docs]</a>    <span class="k">def</span> <span class="nf">handleProcmon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle messages from process monitor: restart disco/actor/device </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msgFrames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">procmon</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">msgFrames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msgFrames</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">(</span><span class="n">qualName</span><span class="p">,)</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="n">qualName</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DISCONAME</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startDisco</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reinstate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">appName</span><span class="p">,</span><span class="n">actorName</span> <span class="o">=</span> <span class="n">qualName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">appName</span> <span class="o">==</span> <span class="n">record</span><span class="o">.</span><span class="n">app</span> <span class="ow">and</span> <span class="n">actorName</span> <span class="o">==</span> <span class="n">record</span><span class="o">.</span><span class="n">actor</span>                
                <span class="n">appModel</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">model</span>
                <span class="n">actorArgs</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">args</span>
                <span class="k">assert</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="n">actorPid</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span>    
                <span class="bp">self</span><span class="o">.</span><span class="n">stopActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unRegisterActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">actorPid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">appDbase</span><span class="o">.</span><span class="n">delAppActor</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">actorName</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">appModel</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">actorArgs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startActor</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="n">appModel</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">model</span>
                <span class="n">actorArgs</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">args</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stopDevice</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startDevice</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">appModel</span><span class="p">,</span> <span class="n">actorName</span><span class="p">,</span> <span class="n">actorArgs</span><span class="p">)</span>
        <span class="n">py_response</span> <span class="o">=</span> <span class="s1">&#39;ok&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">py_response</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">procmon</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">identity</span><span class="p">,</span><span class="n">payload</span><span class="p">])</span></div>
    
<div class="viewcode-block" id="DeploymentManager.handleFMMon"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleFMMon">[docs]</a>    <span class="k">def</span> <span class="nf">handleFMMon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle fault monitor messages (peer changes from the network)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmmon</span><span class="o">.</span><span class="n">recv_pyobj</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleFMMon: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="n">cmd</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">peer</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;peer+&#39;</span><span class="p">,</span><span class="s1">&#39;peer-&#39;</span><span class="p">)</span>
        <span class="n">qualName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actorName</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapLock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span> <span class="ow">and</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span><span class="o">.</span><span class="n">pid</span>
                <span class="n">control</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">control</span>
                <span class="k">if</span> <span class="n">control</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplCmd</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
                    <span class="n">msgMessage</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;peerInfoMsg&#39;</span><span class="p">)</span>
                    <span class="n">msgMessage</span><span class="o">.</span><span class="n">peerState</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span> <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;peer+&#39;</span> <span class="k">else</span> <span class="s1">&#39;off&#39;</span>
                    <span class="n">msgMessage</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">peer</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="n">msgBytes</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">msgBytes</span><span class="p">)</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span><span class="o">.</span><span class="n">pid</span>
                    <span class="n">identity</span> <span class="o">=</span> <span class="n">actorIdentity</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">pid</span><span class="p">)</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">control</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">header</span><span class="p">,</span><span class="n">payload</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">peerQueue</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>        <span class="c1"># TODO: limit the queue size</span></div>

    
<div class="viewcode-block" id="DeploymentManager.handleNICMon"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleNICMon">[docs]</a>    <span class="k">def</span> <span class="nf">handleNICMon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle NIT state changes messages from NIC monitor</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nicmon</span><span class="o">.</span><span class="n">recv_pyobj</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;nic+&#39;</span><span class="p">,</span><span class="s1">&#39;nic-&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handleNICMon: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">qualName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span>
            <span class="n">appName</span><span class="p">,</span><span class="n">actName</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">app</span><span class="p">,</span><span class="n">record</span><span class="o">.</span><span class="n">actor</span>
            <span class="n">control</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">control</span>
            <span class="k">if</span> <span class="n">control</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplCmd</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
            <span class="n">msgMessage</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s1">&#39;nicStateMsg&#39;</span><span class="p">)</span>
            <span class="n">msgMessage</span><span class="o">.</span><span class="n">nicState</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span> <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s1">&#39;nic+&#39;</span> <span class="k">else</span> <span class="s1">&#39;down&#39;</span>
            <span class="n">msgBytes</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">msgBytes</span><span class="p">)</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchMap</span><span class="p">[</span><span class="n">qualName</span><span class="p">]</span><span class="o">.</span><span class="n">pid</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="n">actorIdentity</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actName</span><span class="p">,</span><span class="n">pid</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">control</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">header</span><span class="p">,</span><span class="n">payload</span><span class="p">])</span></div>

        
<div class="viewcode-block" id="DeploymentManager.handleActorMessage"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.handleActorMessage">[docs]</a>    <span class="k">def</span> <span class="nf">handleActorMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">msgBytes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle a  message that has been sent to the actor</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">deplo_capnp</span><span class="o">.</span><span class="n">DeplCmd</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">msgBytes</span><span class="p">)</span>      

        <span class="n">which</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">which</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;resourceMsg&#39;</span><span class="p">:</span>      <span class="c1"># Resource violation</span>
            <span class="n">what</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">resourceMsg</span><span class="o">.</span><span class="n">which</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handleActorMessage: </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> 
                             <span class="o">%</span> <span class="p">(</span><span class="n">appName</span><span class="p">,</span><span class="n">actorName</span><span class="p">,</span><span class="n">what</span><span class="p">))</span>
            <span class="c1"># TODO: send message to fault manager</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;reinstateCmd&#39;</span><span class="p">:</span>   <span class="c1"># Reinstate command - ignore</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;nicStateMsg&#39;</span><span class="p">:</span>    <span class="c1"># NIC state has changed - ignore</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;peerInfoMsg&#39;</span><span class="p">:</span>    <span class="c1"># Peer info has changed - ignore</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown msg from monitor: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">which</span><span class="p">)</span>
            <span class="k">pass</span></div>
    
<div class="viewcode-block" id="DeploymentManager.terminate"><a class="viewcode-back" href="../../../riaps.deplo.html#riaps.deplo.depm.DeploymentManager.terminate">[docs]</a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, RIAPS Team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>